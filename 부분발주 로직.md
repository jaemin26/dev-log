## 🔍 현재 구현 분석

### 1. 발주대기목록 조회 로직

**파일**: `PurchaseOrderMapper.xml` - `selectRfqSelectedList`

```sql
SELECT h.RFQ_NUM, ...
FROM RFQHD h
LEFT JOIN POHD po ON h.RFQ_NUM = po.RFQ_NUM
WHERE h.PROGRESS_CD = 'J'
  AND h.DEL_FLAG = 'N'
  AND po.PO_NUM IS NULL  -- ❌ 문제: RFQ 레벨에서만 체크
```

**문제점**:

- **RFQ 레벨**에서만 발주 여부를 체크
- 하나의 품목이라도 발주되면 전체 RFQ가 대기목록에서 사라짐
- **품목별 발주 추적 불가**

---

### 2. 발주 생성 로직

**파일**: `PurchaseOrderService.java` - `create()`

```java
// 발주 생성 시
- RFQ 번호 저장: dto.setRfqNo(rfqNo)
- 품목 저장: PODT 테이블에 품목 정보 저장
```

**현재 동작**:

- 선택한 품목만 발주 생성 가능 ✅
- 하지만 **어떤 품목이 발주되었는지 추적 불가** ❌

---

### 3. DB 스키마 분석

**POHD (발주 헤더)**:

```
- PO_NUM (발주번호)
- RFQ_NUM (견적번호) ← RFQ와 연결
```

**PODT (발주 상세)**:

```
- PO_NUM (발주번호)
- LINE_NO (품목 순번)
- ITEM_CD (품목코드)
- ORDER_QT (발주수량)
```

**RFQDT (견적 상세)**:

```
- RFQ_NUM (견적번호)
- LINE_NO (품목 순번)
- ITEM_CD (품목코드)
- RFQ_QT (견적수량)
```

---

## ❌ 문제 시나리오

### 예시: RFQ-2026-0006

```
원래 품목:
├─ ITM20250011: A4 용지 (50개)
├─ ITM20250012: 볼펜 (20개)
└─ ITM20250013: 포스트잇 (30개)
```

### 발주 1: 포스트잇만 발주

```
PO2601160003 생성
└─ ITM20250013: 포스트잇 (30개)
```

### 현재 동작 (❌ 문제):

```sql
-- 발주대기목록 쿼리
LEFT JOIN POHD po ON h.RFQ_NUM = po.RFQ_NUM
WHERE po.PO_NUM IS NULL

-- 결과: RFQ-2026-0006에 PO가 존재하므로
-- 전체 RFQ가 대기목록에서 사라짐!
-- A4 용지, 볼펜도 발주 안 됐는데 안 보임
```

---

## ✅ 올바른 동작 (목표)

### 발주 후 대기목록:

```
RFQ-2026-0006 (남은 품목만 표시)
├─ ITM20250011: A4 용지 (50개) ← 아직 발주 안 됨
└─ ITM20250012: 볼펜 (20개) ← 아직 발주 안 됨
```

---

## 🎯 해결 방안

### 방법 1: 품목별 발주 추적

**발주대기목록 쿼리 수정**:

```sql
SELECT
    h.RFQ_NUM,
    d.ITEM_CD,
    d.ITEM_DESC,
    d.RFQ_QT,
    vd.QUOTE_UNIT_PRC,
    vd.QUOTE_AMT,
    -- 이미 발주된 수량 계산
    COALESCE(SUM(po_dt.ORDER_QT), 0) AS ordered_quantity,
    -- 남은 수량 계산
    (d.RFQ_QT - COALESCE(SUM(po_dt.ORDER_QT), 0)) AS remaining_quantity
FROM RFQHD h
JOIN RFQDT d ON h.RFQ_NUM = d.RFQ_NUM
LEFT JOIN RFQVNDT vd ON d.RFQ_NUM = vd.RFQ_NUM
    AND d.LINE_NO = vd.LINE_NO
    AND vd.SELECT_YN = 'Y'
LEFT JOIN POHD po ON h.RFQ_NUM = po.RFQ_NUM AND po.DEL_FLAG = 'N'
LEFT JOIN PODT po_dt ON po.PO_NUM = po_dt.PO_NUM
    AND d.ITEM_CD = po_dt.ITEM_CD
WHERE h.PROGRESS_CD = 'J'
  AND h.DEL_FLAG = 'N'
GROUP BY h.RFQ_NUM, d.ITEM_CD, d.LINE_NO
HAVING remaining_quantity > 0  -- 남은 수량이 있는 품목만
```

**장점**:

- ✅ 품목별로 정확한 발주 추적
- ✅ 부분 발주 완벽 지원
- ✅ 남은 수량 표시 가능

**단점**:

- 쿼리 복잡도 증가
- 성능 고려 필요 (인덱스 필요)

---

### 방법 2: RFQ 상태 관리 (간단하지만 제한적)

**RFQHD에 상태 추가**:

```
- PROGRESS_CD = 'J' (선정완료)
- PROGRESS_CD = 'P' (부분발주)
- PROGRESS_CD = 'C' (발주완료)
```

**장점**:

- 쿼리 단순
- 구현 빠름

**단점**:

- ❌ 품목별 추적 불가
- ❌ 남은 수량 확인 불가
- ❌ 유연성 부족